#  تصميم قاعدة البيانات - المحور المركزي

---

##  جدول الوكلاء (`agents`)

هذا الجدول أساسي في قاعدة البيانات، وهو اللي يخزن كل وكيل يتصل بالمحور (Hub). نعتبره "سجل الحاضرين" أو "دليل الوكلاء".

الغرض منه حفظ حالة الوكيل بشكل دائم، حتى لو النظام انطفى ورجع يشتغل من جديد.

###  هيكل الجدول

| اسم العمود | نوع البيانات | الوصف |
|------------|--------------|--------|
| `agent_id` | `VARCHAR(255)` | **مفتاح أساسي** – معرف فريد للوكيل (مثلاً: الرقم التسلسلي). |
| `status` | `VARCHAR(50)` | حالة الوكيل: `active`, `inactive`, `cooldown`. |
| `agent_type` | `VARCHAR(100)` | نوع الوكيل (مثلاً: `CPE`, `Core-Switch`). |
| `agent_version` | `VARCHAR(50)` | نسخة البرنامج اللي يشغله الوكيل. |
| `last_ip_address` | `INET` | آخر IP اتصل منه الوكيل. |
| `hub_instance_id` | `VARCHAR(255)` | معرف نسخة المحور اللي يخدم هذا الوكيل. |
| `first_seen_at` | `TIMESTAMP WITH TIME ZONE` | أول مرة دخل فيها الوكيل للنظام. |
| `last_seen_at` | `TIMESTAMP WITH TIME ZONE` | آخر وقت وصل فيه heartbeat من الوكيل. |
| `registered_at` | `TIMESTAMP WITH TIME ZONE` | وقت بدء الجلسة الحالية للوكيل. |
| `metadata` | `JSONB` | معلومات إضافية بصيغة JSON (مثل النظام، الموقع، العميل...). |

---

##  جدول سجل الأوامر (`command_history`)

هذا الجدول مهم جداً لتتبع كل أمر يترسل لأي وكيل. يخدم في **التدقيق (auditing)**، و**تصحيح الأخطاء (debugging)**، و**معرفة كل التفاصيل التشغيلية**.

###  هيكل الجدول

| اسم العمود | نوع البيانات | الوصف |
|------------|--------------|--------|
| `job_id` | `UUID` | **مفتاح أساسي** – معرف فريد لكل مهمة أو أمر. |
| `agent_id` | `VARCHAR(255)` | **مفتاح أجنبي** – يشير إلى الوكيل المستهدف في جدول `agents`. |
| `requested_by_user_id` | `UUID` | **مفتاح أجنبي** – يشير للمستخدم اللي طلب تنفيذ الأمر. |
| `command_name` | `VARCHAR(255)` | اسم الأمر (مثلاً: `get_status`, `reboot`). |
| `request_payload` | `JSONB` | الطلب اللي تم إرساله فعلياً للوكيل. |
| `status` | `VARCHAR(50)` | حالة الأمر: `pending`, `sent`, `completed`, `failed`, `timeout`. |
| `response_payload` | `JSONB` | الرد اللي رجع من الوكيل. (يكون `NULL` لو فشل). |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | وقت إنشاء الأمر. |
| `completed_at` | `TIMESTAMP WITH TIME ZONE` | وقت اكتماله (نجاح أو فشل). |

---

##  جدول توكنات المصادقة للوكلاء (`agent_auth_tokens`)

هذا الجدول يربط كل وكيل بتوكن أو أكثر، ويساعدك تتحكم بصلاحية التوكنات، وتتابع متى وكيف تم استخدامها.

###  هيكل الجدول

| اسم العمود | نوع البيانات | الوصف |
|------------|--------------|--------|
| `token_id` | `UUID` | **مفتاح أساسي** – معرف فريد لكل توكن. |
| `agent_id` | `VARCHAR(255)` | **مفتاح أجنبي** – يشير إلى الوكيل في جدول `agents`. |
| `token_hash` | `VARCHAR(255)` | **أهم حقل** – يتم تخزين هاش التوكن، وليس التوكن نفسه. |
| `status` | `VARCHAR(50)` | حالة التوكن: `active`، `revoked`. |
| `created_at` | `TIMESTAMP WITH TIME ZONE` | وقت إنشاء التوكن. |
| `expires_at` | `TIMESTAMP WITH TIME ZONE` | تاريخ انتهاء صلاحية التوكن (يمكن يكون `NULL`). |
| `last_used_at` | `TIMESTAMP WITH TIME ZONE` | آخر مرة تم استخدام التوكن للمصادقة بنجاح. |

---

##  آلية العمل مع جدول التوكنات

### 1️ تجهيز الوكيل (Provisioning)
قبل ما يشتغل الوكيل:

- يتم تسجيل الوكيل في جدول `agents` بحالة `inactive` أو `pending_activation`.
- يتم إنشاء توكن عشوائي قوي (مثلاً: `my_secret_agent_token_12345`).
- يُعمل له هاش قوي (مثل Argon2 أو bcrypt).
- يُخزن الهاش في جدول `agent_auth_tokens` مع تاريخ الانتهاء إن وُجد.
- يُسلم التوكن الأصلي للوكيل (مرة وحدة فقط، يتخزن عنده بأمان).

### 2️ الاتصال والمصادقة (Agent Authentication)

- الوكيل يرسل:
  - `agent_id`
  - `token` (الأصلي من عنده)

- المحور ينفذ:
  - يبحث عن توكن فعال لهذا الوكيل.
  - يقارن هاش التوكن المستلم مع `token_hash` في القاعدة.
  - يتحقق أن التوكن **ما انتهتش صلاحيته**.

### 3️ نتيجة التحقق

- ✅ لو التوكن مطابق وصالح:
  - يتم تحديث `status = active` في جدول `agents`.
  - يتم تحديث `last_used_at` في جدول `agent_auth_tokens`.
  - تبدأ الجلسة.

- ❌ لو التوكن غلط أو منتهي:
  - يرفض الاتصال.
  - (اختياري) يسجل محاولة فاشلة في سجل خاص للأمان.

---


flowchart TD
Start --> Stop
