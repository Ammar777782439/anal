

#  مصادقة ثنائية الطبقات للوكلاء (2-Layer Agent Authentication)

---

##  الفكرة العامة

احنا هنا ننتقل من مصادقة بسيطة مبنية على توكن واحد، إلى نظام أقوى وأأمن فيه **مصادقة من طبقتين**:

1. **توكن تأسيس طويل العمر (Provisioning Token)**
2. **توكن جلسة مؤقت (Session Token)**

زي اللي يحصل في الواقع:

- معك مفتاح كبير يفتح لك الباب أول مرة (توكن التأسيس).
- بعدين يعطوك كرت دخول مؤقت تفتحه به الغرف، ينتهي بعد وقت معين (JWT الجلسة).

---

##  الطبقة الأولى: توكن التأسيس (Provisioning Token)

- هذا التوكن يتم إنشاؤه مرة وحدة، ويُخزن **الهاش** حقه في جدول `agent_auth_tokens`.
- الغرض منه **إثبات هوية الوكيل** وقت ما يحاول يتصل بالمحور لأول مرة أو لو انتهت الجلسة.
- ما يُستخدمش لتنفيذ أوامر، فقط **لبداية الجلسة**.

---

##  الطبقة الثانية: توكن الجلسة المؤقت (JWT)

- لما تنجح مصادقة التأسيس، المحور يولد JWT جديد.
- هذا الـ JWT يُستخدم في **كل الطلبات التشغيلية اليومية** (scan, get_location, heartbeat...).
- عمره قصير (مثلاً: 15 دقيقة)، وبعدها لازم الوكيل يرجع يصادق من جديد.

---

##  ليش هذا التصميم أفضل؟

| الميزة       | الفائدة                                                      |
| ------------ | ------------------------------------------------------------ |
| أمان أعلى    | التوكن الأساسي الحساس ما يتم نقله إلا نادر.                  |
| سرعة التحقق  | الـ JWT يتم التحقق منه بدون الرجوع لقاعدة البيانات.          |
| تحكم بالجلسة | كل وكيل ملزوم يجدد جلسته باستمرار، ما في جلسات مفتوحة للأبد. |
|  تتبع ووضوح  | سهل تعرف متى بدأت الجلسة، ومتى انتهت، ومن أي وكيل.           |

---

##  تنفيذ JWT من طرف المحور يعني الخادم GRPC

لما ينجح الوكيل في المصادقة الأولية، المحور يولد JWT فيه:

- `sub`: رقم الوكيل `agent_id`
- `exp`: وقت انتهاء الصلاحية (مثلاً: الآن + 15 دقيقة)
- `iat`: وقت الإصدار
- `jti`: رقم فريد لكل توكن (لمنع إعادة تشغيله)
- يتم توقيع الـ JWT بمفتاح سري عند المحور (secret key)

---

## تسلسل العملية كاملة

###  المرحلة 1: تأسيس الاتصال

**الوكيل يرسل:**
```json
{
  "agent_id": "agent-123",
  "provisioning_token": "abc123"
}
